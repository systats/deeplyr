---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
devtools::document()
pacman::p_load(tidyverse, recipes, tidyr)
```



```{r}
load("gams_sub.Rdata")

games <- gams_sub %>%
  filter(league_id == 82) %>%
  mutate_at(vars(game_id, contains("team_id")), as.integer) %>%
  select(-winner_team_id)

games %>% 
  count(local_team_id, visitor_team_id, sort = T)

train <- games %>% 
  filter(year < 2019)
test <- games %>% 
  filter(year > 2018)
```


```{r}
# devtools::install()
devtools::document()

rec <- recipe(local_team_score + visitor_team_score ~ local_team_id + visitor_team_id + game_id, data = head(games)) %>%
  update_role(game_id, new_role = "ID")

# f1 <- fit_learner(rec, games, params = NULL, task = "linear", backend = "goalmodel")
f2 <- learner$new(params = list(type = "negbin"), task = "linear", backend = "goalmodel")
f2$fit(rec, train[1,])

preds <- f2$predict_feature(test[1,], "w200")
preds
```


```{r}
#' slide_window 
#' @export
slide_window <- function(
    test, 
    train, 
    primitive = NULL,
    window = 60, 
    suffix = ""
){
  
  test %>%
    split(1:nrow(.)) %>%
    furrr::future_map_dfr(~{
      
      ### Define training time ranges
      cuttrain <- .x$date[1] - as.difftime(window + 1, units = "days")
      cuttest <- .x$date[1] - as.difftime(1, units = "days")
      
      ### Filter data by window and league
      focus <- train[
        train$date > cuttrain & 
        train$date < cuttest &
        (train$local_team_id %in% c(.x$local_team_id, .x$visitor_team_id) | 
        train$visitor_team_id %in% c(.x$visitor_team_id, .x$local_team_id)), ]
      
      if(nrow(focus) < 2) {
        empty <- .x %>%
          dplyr::select(game_id, contains("team_id")) %>%
          mutate(error = "n < 2")
        return(empty)
      }
      
      #glimpse(.x[,1])
      primitive(.x, focus, suffix)
    }, .progress = T)
}
```


```{r}
# devtools::document()
# devtools::install()

rec <- recipe(local_team_score + visitor_team_score ~ local_team_id + visitor_team_id + game_id, data = head(train)) %>%
  update_role(game_id, new_role = "ID")

fun <- function(test, train, suffix){

  f2 <- learner$new(params = list(type = "pois"), task = "linear", backend = "goalmodel")
  f2$fit(rec, train) 
  f2$predict_feature(test, suffix)
  
}

library(furrr)
plan(multiprocess)
#plan(sequential)
fea <- slide_window(test[1:1000,], train, fun, suffix = "w100")
```




---
title: "Test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Â´

# Packages

```{r}
pacman::p_load(
  devtools, tidyverse, reticulate, keras, GA, dials, RSQLite, tensorflow,
  magrittr, crayon, R6, furrr, purrr, jsonlite, tidytext, text2vec, tictoc, ggforce, keras,
  plotROC, pROC, tidyr, survival, survminer
)
# devtools::install_github("rstudio/reticulate") #!!!!!

devtools::document()
library(deeplyr)
set.seed(42)
plan(multiprocess)
# plan(multiprocess, workers = 2)
```


# Data

```{r}
#tweets <- readRDS("sample.rds")
```

```{r}
range01 <- function(x){(x-min(x, na.rm = T))/(max(x, na.rm = T)-min(x, na.rm = T))}
load("tweets_batched_250.Rdata")
tweets <- tweets_batched %>% 
  ### sample each person max 100 times
  split(.$voter_id) %>% 
  future_map_dfr(~{
    dsample <- nrow(.x) > 100
    if(dsample){
      return(.x %>% sample_n(100))
    } else {
      return(.x)
    }
  }, .progress = T) %>%
  mutate(
    # nchars = str_length(text),
    # nwords = str_count(text, "\\w+"),
    # age_z = scale(age)[,1],
    # age_01 = range01(age),
    gender = case_when(sex == "female" ~ 1, sex == "male" ~ 0),
    party_2 = case_when(party == "dem" ~ 0, party == "rep" ~ 1),
    party_3 = case_when(
      party == "dem" ~ 1, 
      party == "npa" ~ 2, 
      party == "rep" ~ 3
    ),
    theta_01 = range01(theta),
    theta_log = log(theta), 
    theta_z = scale(theta)[,1],
    theta_sqrt = sqrt(theta),
    theta_3 = ntile(theta, 3)
  ) %>%
  #dplyr::sample_n(1000) %>%
  dplyr::arrange(sample(1:n(), n()))

# tweets %>% 
#   sample_n(10000) %>% 
#   dataMaid::makeDataReport(data = ., output = "html", file = "report_y", vol = 1, replace = T)
# saveRDS(tweets, file = "../../test/sample.rds")

tweets %>%
  #count(voter_id, sort = T) %>%
  glimpse
```



```{r}
#devtools::document()
library(deeplyr)

dp <- list(
  text = "lemma",
  input_dim = 30000,
  seq_len = 250,
  term_count_min = 3,
  doc_proportion_max  = .1
)

options(future.globals.maxSize = 1024^4)
sc <- create_seq_container(param = dp, data = tweets, parallel = F)
sc$data %>% glimpse
sc$x[1:5, 1:10]
sc$report()



# 30000
sc <- get(load("data/container/718fb6c9420e7c14e36fc84e305d5721/data_container.Rdata"))
sc$get_param()


# 5000
# sc <- get(load("data/container/c1989b85dfce02f8537ecb802cc16272/data_container.Rdata"))
# sc$get_param()
```

# Fit them all

```{r}
#devtools::document()
devtools::document()
fit_model <- function(backend, ..., folder = "."){
  f <- deeplyr::learner$new(backend)
  f$set(...)
  f$train(cv = F)
  f$test()
  f$report(folder)
  return(f)
}
```



# Models

## Theta Linear

```{r}
mpl <- list(
  output_dim = 1,
  embed_dim = 128,
  batch_size = 100,
  epochs = 1, 
  target = "theta",
  model  = deeplyr::keras_cnn_lstm,
  model_name = "custom"
)

fl1 <- fit_model(
  "keras:linear",
  param = mpl,
  container = sc,
  oos = T,
  val = F,
  id = "voter_id"
)

# nn <- preds %>% 
#   mutate(target = target, pred = scale(pred)[,1])
# 
# mean(sqrt((nn$target - nn$pred)^2))
# mean((nn$target - nn$pred)^2)

fl1$perform %>% gather(measure, value) %>% knitr::kable()
do.call(gridExtra::grid.arrange, c(fl1$plots, list(ncol = 2)))
```


## Theta Categorical

```{r}
#devtools::document()
mptc <- list(
  output_dim = 3,
  embed_dim = 128,
  batch_size = 100,
  epochs = 1, 
  class_weights = T,
  target = "theta_3",
  model  = deeplyr::keras_multi_cnn
)

f3 <- fit_model(
  "keras:categorical",
  param = mptc,
  container = sc,
  oos = T,
  val = T,
  id = "voter_id"
)

f3$perform %>% gather(measure, value) %>% knitr::kable()
do.call(gridExtra::grid.arrange, c(f3$plots[1:4], list(ncol = 2)))
f3$plots$multi_surv
```


## Party Binary

```{r}
mpb <- list(
  output_dim = 1,
  embed_dim = 128,
  batch_size = 100,
  epochs = 1, 
  target = "party_2",
  model  = deeplyr::keras_multi_cnn,
  model_name = "custom"
)

f2 <- fit_model(
  "keras:binary",
  param = mpb,
  container = sc,
  oos = T,
  val = T,
  id = "voter_id"
)

f2$perform %>% gather(measure, value) %>% knitr::kable()
do.call(gridExtra::grid.arrange, c(f2$plots[1:4], list(ncol = 2)))
f2$plots$surv
```




# GA

## Theta

### One model

```{r}
devtools::document()

p_simple_mlp <- list(
  embed_dim = p_integer(62, 256),
  dense_dim = p_integer(10, 100),
  dropout = p_double(.1, .5)
)

static <- list(
  output_dim = 1,
  batch_size = 100,
  epochs = 1, 
  target = "theta",
  model  = deeplyr::keras_simple_mlp,
  model_name = "simple_mlp"
)

my_fun <- function(.x, folder){
  m <- fit_model("keras:linear", param = .x, container = sc, 
                 oos = T, val = T, id = "voter_id", folder = folder)
  return(m$perform)
} 

grid1 <- fit_ga(
  fun = my_fun, 
  hyper = p_simple_mlp,
  param = static, 
  folder = "first_simple_mlp",
  metric = "mse",
  minimize = T,
  popSize = 10, 
  maxiter = 3, # main run argument 
  run = 3
)
```


### Many Models

```{r}
model_inputs <- list(
  simple_mlp = list(
    model = deeplyr::keras_simple_mlp,
    hyper = list(
      embed_dim = p_integer(64, 256),
      dense_dim = p_integer(10, 100),
      dropout = p_double(.1, .5)
    )
  ),
  # cnn_lstm = list(
  #   model = deeplyr::keras_cnn_lstm,
  #   hyper = list(
  #     #epochs = p_integer(1, 3),
  #     embed_dim = p_integer(128, 256),
  #     n_filters = p_integer(64, 128),
  #     lstm_dim = p_integer(32, 128),
  #     dropout = p_double(.1, .5)
  #   )
  # )
  multi_cnn = list(
    model = deeplyr::keras_multi_cnn,
    hyper = list(
      embed_dim = p_integer(64, 256),
      n_filters = p_integer(64, 256)
    )
  ),
  pooled_gru = list(
    model = deeplyr::keras_pooled_gru,
    hyper = list(
      embed_dim = p_integer(64, 256),
      gru_dim = p_integer(32, 180),
      gru_drop = p_double(.1, .5)
    )
  )
)

model_inputs %>% 
  iwalk(~{
  
    static <- list(
      output_dim = 1,
      batch_size = 100,
      epochs = 1, 
      target = "theta",
      model  = .x$model,
      model_name = .y
    )
    
    my_fun <- function(.x, folder){
      m <- fit_model("keras:linear", param = .x, container = sc, 
                     oos = T, val = T, id = "voter_id", folder = folder)
      return(m$perform)
    } 
    
    fit_ga(
      fun = my_fun, 
      hyper = .x$hyper,
      param = static, 
      folder = "multi_model_grid2",
      metric = "mae",
      minimize = T,
      popSize = 10, 
      maxiter = 3, # main run argument 
      run = 3
    )
  })
```





### Load

```{r}
load_grid <- function(folder){
  dir(glue::glue("models/{folder}"), full.names = T) %>% 
    map(dir, full.names = T) %>% 
    map(~.x %>% keep(~str_detect(.x, ".json"))) %>% 
    map_df(read_json) %>% 
    mutate(metrics = metrics %>% map(bind_cols))
}

grid_multi1 <- load_grid(folder = "multi_model_grid")%>%
  unnest(metrics) %>% 
  arrange(mae) %>%
  #ggplot(aes(x = mse)) + geom_histogram()
  glimpse

grid_multi2 <- load_grid(folder = "multi_model_grid2")%>%
  unnest(metrics) %>% 
  arrange(mae) %>%
  #ggplot(aes(x = mse)) + geom_histogram()
  glimpse

#save(grid_multi, file = "grid_multi.Rdata")

grid_multi1 %>%
  bind_rows(grid_multi2) %>% 
  ggplot(aes(model_name, mae, fill = model_name)) +
  geom_violin(color = NA) +
  facet_wrap(~input_dim)
```


```{r}
load_model <- function(id, folder = NULL){
  if(!is.null(folder)) folder <- paste0(folder, "/")
  path <- glue::glue("models/{folder}{id}/model_container.Rdata")
  print(path)
  return(get(load(path)))
}

m <- load_model( id = "0e08842aa52c7fb89f9ce218e13cb000", folder = "multi_model_grid")
# save(m, file = "best_model.Rdata")
m$preds %>% plot_linear()
m$perform
m$results
m$preds %>% 
  rename(actual = target) %>%
  ggplot(aes(pred, actual)) +
  #geom_jitter(alpha = .1) +
  geom_bin2d(alpha = .5) +
  #geom_density_2d()+ 
  geom_smooth(method = "lm", se = F) +
  geom_smooth(color = "red") +
  geom_rug(position = "jitter", alpha = .05) +
  scale_fill_viridis_c(direction = -1, option = "B") +
  theme_classic() +
  ggtitle("y = theta, MAE = .56")

# m$perform
# class(m)
# methods(print)
# 
# print.learner <- function(x) return(x)
# rm(print.learner)
# m %>%
#   as.list
#   map(1)
```


## Party

```{r}
devtools::document()
model_inputs <- list(
  simple_mlp = list(
    model = deeplyr::keras_simple_mlp,
    hyper = list(
      embed_dim = p_integer(64, 256),
      dense_dim = p_integer(10, 100),
      dropout = p_double(.1, .5)
    )
  ),
  cnn_lstm = list(
    model = deeplyr::keras_cnn_lstm,
    hyper = list(
      #epochs = p_integer(1, 3),
      embed_dim = p_integer(128, 256),
      n_filters = p_integer(64, 128),
      lstm_dim = p_integer(32, 128),
      dropout = p_double(.1, .5)
    )
  ),
  multi_cnn = list(
    model = deeplyr::keras_multi_cnn,
    hyper = list(
      embed_dim = p_integer(64, 256),
      n_filters = p_integer(64, 256)
    )
  ),
  pooled_gru = list(
    model = deeplyr::keras_pooled_gru,
    hyper = list(
      embed_dim = p_integer(64, 256),
      gru_dim = p_integer(32, 180),
      gru_drop = p_double(.1, .5)
    )
  )
)

model_inputs %>% 
  iwalk(~{
  
    static <- list(
      output_dim = 1,
      batch_size = 100,
      epochs = 1, 
      class_weights = T,
      target = "party_2",
      model  = .x$model,
      model_name = .y
    )
    
    my_fun <- function(.x, folder){
      m <- fit_model("keras:binary", param = .x, container = sc, 
                     oos = T, val = T, id = "voter_id", folder = folder)
      return(m$perform)
    } 
    
    fit_ga(
      fun = my_fun, 
      hyper = .x$hyper,
      param = static, 
      folder = "grid_party_binary_1",
      metric = "accuracy",
      minimize = F,
      popSize = 10, 
      maxiter = 3, # main run argument 
      run = 3
    )
  })

sc$get_param()
```


```{r}
grid_multi_binary1 <- load_grid(folder = "grid_party_binary_1")%>%
  unnest(metrics) %>% 
  arrange(desc(accuracy)) %>%
  #ggplot(aes(x = mse)) + geom_histogram()
  glimpse

grid_multi_binary1 %>%
  ggplot(aes(model_name, accuracy)) +
  geom_violin()
  
```


```{r}


m_b1 <- load_model( id = "8c6087546d1d7c463495af7fcf394fb3", folder = "grid_party_binary_1")
m_b1$plots
m_b1$results
```









